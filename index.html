<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="PEA" />
  <meta name="theme-color" content="#0a0a0f" />
  <title>PEA Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg:#0a0a0f; --surface:#111118; --surface2:#1a1a24;
      --border:rgba(255,255,255,0.07); --gold:#c9a84c; --gold-light:#e8c97a;
      --green:#3ecf8e; --text:#f0ede6; --text-muted:rgba(240,237,230,0.45);
      --text-dim:rgba(240,237,230,0.2); --danger:#ff5c5c;
      --shadow:rgba(0,0,0,0.3); --radius:16px;
    }
    html.light {
      --bg:#f5f2ec; --surface:#ffffff; --surface2:#ede9e1;
      --border:rgba(0,0,0,0.08); --gold:#a07828; --gold-light:#b8892e;
      --green:#1a9e6a; --text:#1a1612; --text-muted:rgba(26,22,18,0.5);
      --text-dim:rgba(26,22,18,0.25); --danger:#d93c3c; --shadow:rgba(0,0,0,0.08);
    }
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body { height:100%; background:var(--bg); color:var(--text); font-family:'Syne',sans-serif; overscroll-behavior:none; transition:background 0.3s ease, color 0.3s ease; }
    body { min-height:100vh; padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); display:flex; flex-direction:column; }

    .screen { flex:1; display:none; }
    .screen.active { display:flex; }
    
    /* LOADER */
    .loader-screen { flex-direction:column; align-items:center; justify-content:center; gap:16px; }
    .loader-logo { font-size:12px; font-weight:700; letter-spacing:0.25em; text-transform:uppercase; color:var(--gold); }
    .loader-spinner { width:28px; height:28px; border:2px solid var(--border); border-top-color:var(--gold); border-radius:50%; animation:spin 0.8s linear infinite; }
    @keyframes spin { to{transform:rotate(360deg)} }
    
    /* AUTH */
    .auth-screen { flex-direction:column; align-items:center; justify-content:center; padding:40px 24px; gap:32px; }
    .auth-logo { font-size:14px; font-weight:800; letter-spacing:0.3em; text-transform:uppercase; color:var(--gold); }
    .auth-tagline { font-family:'DM Mono',monospace; font-size:12px; color:var(--text-muted); text-align:center; max-width:320px; line-height:1.6; }
    .auth-card { background:var(--surface); border:1px solid var(--border); border-radius:20px; padding:32px; width:100%; max-width:420px; box-shadow:0 4px 24px var(--shadow); }
    .auth-tabs { display:flex; gap:8px; margin-bottom:24px; }
    .auth-tab { flex:1; padding:12px; background:transparent; border:1px solid var(--border); border-radius:10px; color:var(--text-muted); font-family:'Syne',sans-serif; font-size:13px; font-weight:600; cursor:pointer; transition:all 0.2s; }
    .auth-tab.active { background:var(--gold); color:#0a0a0f; border-color:var(--gold); }
    .auth-tab:not(.active):active { opacity:0.7; }
    .auth-field { margin-bottom:16px; }
    .auth-field label { display:block; font-size:10px; font-weight:700; letter-spacing:0.15em; text-transform:uppercase; color:var(--text-muted); margin-bottom:8px; }
    .auth-field input { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:12px; padding:14px 16px; color:var(--text); font-family:'DM Mono',monospace; font-size:15px; outline:none; transition:border-color 0.2s; }
    .auth-field input:focus { border-color:var(--gold); }
    .auth-btn { width:100%; background:var(--gold); color:#0a0a0f; border:none; border-radius:12px; padding:16px; font-family:'Syne',sans-serif; font-size:14px; font-weight:700; cursor:pointer; margin-top:8px; transition:opacity 0.2s; }
    .auth-btn:active { opacity:0.85; }
    .auth-btn:disabled { opacity:0.5; cursor:not-allowed; }
    .auth-error { background:rgba(255,92,92,0.1); border:1px solid rgba(255,92,92,0.3); border-radius:10px; padding:12px 16px; margin-bottom:16px; color:var(--danger); font-family:'DM Mono',monospace; font-size:11px; display:none; }
    .auth-error.show { display:block; }
    .auth-divider { display:flex; align-items:center; gap:12px; margin:20px 0; color:var(--text-dim); font-size:11px; }
    .auth-divider::before,.auth-divider::after { content:''; flex:1; height:1px; background:var(--border); }
    .auth-google { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:12px; padding:14px; font-family:'Syne',sans-serif; font-size:13px; font-weight:600; color:var(--text); cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; transition:background 0.2s; }
    .auth-google:active { background:var(--surface); }
    
    /* APP */
    .app-screen { flex-direction:column; }
    .header { padding:20px 24px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); }
    .header-left { display:flex; align-items:center; gap:12px; }
    .header-avatar { width:32px; height:32px; border-radius:50%; background:linear-gradient(135deg,var(--gold),var(--gold-light)); display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:800; color:#0a0a0f; }
    .header-username { font-size:14px; font-weight:700; }
    .header-right { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .btn-logout { background:var(--surface2); border:1px solid var(--border); border-radius:20px; padding:8px 14px; font-family:'DM Mono',monospace; font-size:10px; color:var(--text-muted); cursor:pointer; white-space:nowrap; }
    .btn-logout:active { opacity:0.7; }
    .theme-toggle { background:var(--surface2); border:1px solid var(--border); border-radius:20px; padding:6px 12px; cursor:pointer; display:flex; align-items:center; gap:6px; color:var(--text-muted); font-family:'DM Mono',monospace; font-size:10px; }
    .theme-toggle:active { opacity:0.7; }
    .header-date { font-family:'DM Mono',monospace; font-size:10px; color:var(--text-dim); }
    .sync-bar { padding:8px 24px; font-family:'DM Mono',monospace; font-size:10px; color:var(--text-dim); display:flex; align-items:center; gap:6px; }
    .sync-dot { width:6px; height:6px; border-radius:50%; background:var(--text-dim); }
    .sync-dot.synced { background:var(--green); }
    .sync-dot.syncing { background:var(--gold); animation:pulse 1s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
    .scroll { flex:1; overflow-y:auto; padding:20px 16px 140px; }
    
    /* Cards identiques version perso */
    .hero { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:24px; position:relative; overflow:hidden; box-shadow:0 2px 12px var(--shadow); margin-bottom:16px; }
    .hero::before { content:''; position:absolute; top:-60px; right:-60px; width:200px; height:200px; background:radial-gradient(circle,rgba(201,168,76,0.12),transparent 70%); pointer-events:none; }
    .hero-label { font-size:10px; font-weight:700; letter-spacing:0.2em; text-transform:uppercase; color:var(--text-muted); margin-bottom:8px; }
    .hero-amount { font-family:'DM Mono',monospace; font-size:42px; font-weight:500; color:var(--gold-light); line-height:1; letter-spacing:-1px; margin-bottom:4px; }
    .hero-amount span { font-size:22px; opacity:0.6; }
    .hero-sub { font-family:'DM Mono',monospace; font-size:12px; color:var(--text-muted); margin-bottom:20px; }
    .hero-sub b { color:var(--green); font-weight:400; }
    .progress-track { height:6px; background:var(--surface2); border-radius:99px; overflow:hidden; margin-bottom:8px; }
    .progress-fill { height:100%; border-radius:99px; background:linear-gradient(90deg,var(--gold),var(--gold-light)); transition:width 0.6s; position:relative; }
    .progress-fill::after { content:''; position:absolute; right:0; top:50%; transform:translateY(-50%); width:10px; height:10px; border-radius:50%; background:var(--gold-light); box-shadow:0 0 8px var(--gold); }
    .progress-labels { display:flex; justify-content:space-between; font-family:'DM Mono',monospace; font-size:10px; color:var(--text-dim); }
    .progress-pct { font-weight:500; color:var(--gold); }
    .stats-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px; }
    .stat-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:0 2px 8px var(--shadow); }
    .stat-card.highlight { border-color:rgba(62,207,142,0.25); background:linear-gradient(135deg,var(--surface),rgba(62,207,142,0.04)); }
    .stat-label { font-size:9px; font-weight:700; letter-spacing:0.18em; text-transform:uppercase; color:var(--text-muted); margin-bottom:8px; }
    .stat-value { font-family:'DM Mono',monospace; font-size:20px; font-weight:500; color:var(--text); line-height:1; }
    .stat-value.green { color:var(--green); }
    .stat-sub { font-family:'DM Mono',monospace; font-size:10px; color:var(--text-dim); margin-top:4px; }
    .chart-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:20px; box-shadow:0 2px 12px var(--shadow); margin-bottom:16px; }
    .chart-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .chart-title { font-size:9px; font-weight:700; letter-spacing:0.18em; text-transform:uppercase; color:var(--text-muted); }
    .chart-total { font-family:'DM Mono',monospace; font-size:12px; color:var(--gold-light); }
    .chart-wrap { position:relative; height:120px; }
    canvas#chartCanvas { width:100%; height:100%; }
    .chart-empty { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-family:'DM Mono',monospace; font-size:11px; color:var(--text-dim); }
    .chart-empty.hidden { display:none; }
    .est-card { background:var(--surface); border:1px solid rgba(201,168,76,0.2); border-radius:var(--radius); padding:20px 24px; display:flex; align-items:center; gap:16px; margin-bottom:16px; }
    .est-icon { font-size:28px; }
    .est-label { font-size:9px; font-weight:700; letter-spacing:0.2em; text-transform:uppercase; color:var(--text-muted); margin-bottom:4px; }
    .est-date { font-family:'DM Mono',monospace; font-size:18px; color:var(--gold-light); font-weight:500; }
    .est-detail { font-family:'DM Mono',monospace; font-size:10px; color:var(--text-dim); margin-top:2px; }
    .section-title { font-size:10px; font-weight:700; letter-spacing:0.2em; text-transform:uppercase; color:var(--text-muted); padding:0 4px; display:flex; align-items:center; gap:10px; margin-bottom:12px; }
    .section-title::after { content:''; flex:1; height:1px; background:var(--border); }
    .history-list { display:flex; flex-direction:column; gap:8px; }
    .history-item { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:14px 18px; display:flex; align-items:center; justify-content:space-between; animation:slideIn 0.3s; }
    @keyframes slideIn { from{opacity:0;transform:translateY(-8px)} to{opacity:1;transform:translateY(0)} }
    .history-left { display:flex; flex-direction:column; gap:3px; }
    .history-date { font-family:'DM Mono',monospace; font-size:11px; color:var(--text-muted); }
    .history-note { font-size:12px; color:var(--text-dim); font-style:italic; }
    .history-amount { font-family:'DM Mono',monospace; font-size:16px; font-weight:500; color:var(--green); }
    .history-delete { background:none; border:none; color:var(--text-dim); font-size:16px; padding:4px 8px; cursor:pointer; border-radius:8px; margin-left:4px; }
    .history-delete:active { color:var(--danger); background:rgba(255,92,92,0.1); }
    .history-edit { background:none; border:none; color:var(--text-dim); font-size:14px; padding:4px 8px; cursor:pointer; border-radius:8px; margin-left:10px; }
    .history-edit:active { color:var(--gold); background:rgba(201,168,76,0.1); }
    .auto-badge { display:inline-block; font-size:9px; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; background:rgba(62,207,142,0.12); color:var(--green); border:1px solid rgba(62,207,142,0.25); border-radius:6px; padding:2px 6px; margin-left:6px; }
    .empty-state { text-align:center; padding:30px; color:var(--text-dim); font-family:'DM Mono',monospace; font-size:12px; }
    .fab { position:fixed; bottom:calc(24px + env(safe-area-inset-bottom)); left:50%; transform:translateX(-50%); z-index:100; display:flex; gap:10px; }
    .btn-add { background:var(--gold); color:#0a0a0f; border:none; border-radius:40px; padding:16px 28px; font-family:'Syne',sans-serif; font-size:14px; font-weight:700; cursor:pointer; box-shadow:0 4px 20px rgba(201,168,76,0.4); }
    .btn-add:active { transform:scale(0.96); }
    .btn-settings { background:var(--surface2); color:var(--text-muted); border:1px solid var(--border); border-radius:40px; padding:16px 18px; font-size:18px; cursor:pointer; }
    .btn-settings:active { background:var(--surface); }
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); z-index:200; display:none; align-items:flex-end; }
    .overlay.open { display:flex; }
    .modal { width:100%; background:var(--surface); border-radius:24px 24px 0 0; padding:12px 24px calc(32px + env(safe-area-inset-bottom)); animation:slideUp 0.3s; box-shadow:0 -4px 30px var(--shadow); }
    @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
    .modal-handle { width:36px; height:4px; background:var(--border); border-radius:99px; margin:0 auto 20px; }
    .modal-title { font-size:18px; font-weight:700; margin-bottom:24px; }
    .field { margin-bottom:16px; }
    .field label { display:block; font-size:10px; font-weight:700; letter-spacing:0.18em; text-transform:uppercase; color:var(--text-muted); margin-bottom:8px; }
    .field input { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:12px; padding:14px 16px; color:var(--text); font-family:'DM Mono',monospace; font-size:16px; outline:none; }
    .field input:focus { border-color:var(--gold); }
    .modal-btns { display:grid; grid-template-columns:1fr 2fr; gap:12px; margin-top:8px; }
    .btn-cancel { background:var(--surface2); border:1px solid var(--border); border-radius:12px; padding:16px; color:var(--text-muted); font-family:'Syne',sans-serif; font-size:14px; font-weight:600; cursor:pointer; }
    .btn-confirm { background:var(--gold); border:none; border-radius:12px; padding:16px; color:#0a0a0f; font-family:'Syne',sans-serif; font-size:14px; font-weight:700; cursor:pointer; }
    .btn-cancel:active,.btn-confirm:active { opacity:0.7; }
    .settings-info { font-family:'DM Mono',monospace; font-size:11px; color:var(--text-muted); margin-bottom:20px; line-height:1.6; white-space:pre-line; }
    .danger-zone { margin-top:8px; padding:14px 16px; background:rgba(255,92,92,0.06); border:1px solid rgba(255,92,92,0.2); border-radius:12px; }
    .danger-zone-title { font-size:9px; font-weight:700; letter-spacing:0.18em; text-transform:uppercase; color:var(--danger); margin-bottom:10px; }
    .btn-danger { background:none; border:1px solid rgba(255,92,92,0.3); border-radius:10px; padding:10px 16px; color:var(--danger); font-family:'Syne',sans-serif; font-size:13px; font-weight:600; cursor:pointer; width:100%; }
    .btn-danger:active { background:rgba(255,92,92,0.1); }
    #confetti-canvas { position:fixed; inset:0; pointer-events:none; z-index:999; }
    
    /* FAQ */
    .faq-section { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; box-shadow:0 2px 8px var(--shadow); }
    .faq-header { display:flex; align-items:center; justify-content:space-between; padding:16px 20px; cursor:pointer; user-select:none; gap:12px; }
    .faq-header:active { opacity:0.75; }
    .faq-header-left { display:flex; align-items:center; gap:10px; }
    .faq-header-icon { font-size:16px; }
    .faq-header-title { font-size:11px; font-weight:700; letter-spacing:0.18em; text-transform:uppercase; color:var(--text-muted); }
    .faq-chevron { font-family:'DM Mono',monospace; font-size:14px; color:var(--text-dim); transition:transform 0.25s; }
    .faq-section.open .faq-chevron { transform:rotate(180deg); }
    .faq-body { display:none; border-top:1px solid var(--border); }
    .faq-section.open .faq-body { display:block; }
    .faq-item { padding:16px 20px; border-bottom:1px solid var(--border); }
    .faq-item:last-child { border-bottom:none; }
    .faq-question { font-size:13px; font-weight:700; color:var(--text); margin-bottom:6px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .faq-question-chevron { font-family:'DM Mono',monospace; font-size:11px; color:var(--text-dim); transition:transform 0.2s; flex-shrink:0; }
    .faq-item.open .faq-question-chevron { transform:rotate(180deg); }
    .faq-answer { font-family:'DM Mono',monospace; font-size:11px; color:var(--text-muted); line-height:1.7; display:none; margin-top:4px; }
    .faq-item.open .faq-answer { display:block; }

    /* RESPONSIVE */
    .main-grid { width:100%; display:flex; flex-direction:column; gap:16px; }
    .main-grid > * { margin-bottom:0; }

    @media (min-width:768px) {
      .scroll { padding-left:24px; padding-right:24px; }
      .main-grid { max-width:960px; margin:0 auto; }
      .header { padding-left:max(24px, calc((100vw - 960px) / 2)); padding-right:max(24px, calc((100vw - 960px) / 2)); }
      .sync-bar { padding-left:max(24px, calc((100vw - 960px) / 2)); padding-right:max(24px, calc((100vw - 960px) / 2)); }
      .stats-row { grid-template-columns:repeat(4,1fr); }
    }

    @media (min-width:1100px) {
      .main-grid {
        max-width:1400px;
        display:grid;
        grid-template-columns:1fr 1fr;
        column-gap:20px;
        row-gap:16px;
        align-items:start;
      }
      .header { padding-left:max(24px, calc((100vw - 1400px) / 2)); padding-right:max(24px, calc((100vw - 1400px) / 2)); }
      .sync-bar { padding-left:max(24px, calc((100vw - 1400px) / 2)); padding-right:max(24px, calc((100vw - 1400px) / 2)); }
      .faq-section  { grid-column:1 / -1; grid-row:1; }
      .hero         { grid-column:1 / -1; grid-row:2; }
      .stats-row    { grid-column:1; grid-row:3; grid-template-columns:repeat(2,1fr); }
      .chart-card   { grid-column:2; grid-row:3 / 6; }
      .est-card     { grid-column:1; grid-row:4; }
      .section-title{ grid-column:1 / -1; grid-row:6; }
      .history-list { grid-column:1 / -1; grid-row:7; }
      .chart-wrap   { height:240px; }
    }

    @media (min-width:1600px) {
      .main-grid { max-width:1600px; }
      .header { padding-left:max(24px, calc((100vw - 1600px) / 2)); padding-right:max(24px, calc((100vw - 1600px) / 2)); }
      .sync-bar { padding-left:max(24px, calc((100vw - 1600px) / 2)); padding-right:max(24px, calc((100vw - 1600px) / 2)); }
    }
  </style>
</head>
<body>

  <canvas id="confetti-canvas"></canvas>

  <!-- LOADER -->
  <div class="screen loader-screen active" id="loaderScreen">
    <div class="loader-logo">‚ñ≤ PEA Tracker</div>
    <div class="loader-spinner"></div>
  </div>

  <!-- AUTH -->
  <div class="screen auth-screen" id="authScreen">
    <div>
      <div class="auth-logo">‚ñ≤ PEA TRACKER</div>
      <div class="auth-tagline">Suivez l'√©volution de votre PEA et estimez quand vous atteindrez le plafond de 150 000 ‚Ç¨</div>
    </div>
    <div class="auth-card">
      <div class="auth-tabs">
        <button class="auth-tab active" id="tabSignin" onclick="switchTab('signin')">Connexion</button>
        <button class="auth-tab" id="tabSignup" onclick="switchTab('signup')">Inscription</button>
      </div>
      <div id="authError" class="auth-error"></div>
      <div id="signinForm">
        <div class="auth-field"><label>Email</label><input type="email" id="signinEmail" placeholder="vous@exemple.fr" /></div>
        <div class="auth-field"><label>Mot de passe</label><input type="password" id="signinPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
        <button class="auth-btn" onclick="signin()">Se connecter</button>
      </div>
      <div id="signupForm" style="display:none">
        <div class="auth-field"><label>Pr√©nom</label><input type="text" id="signupName" placeholder="Votre pr√©nom" maxlength="30" /></div>
        <div class="auth-field"><label>Email</label><input type="email" id="signupEmail" placeholder="vous@exemple.fr" /></div>
        <div class="auth-field"><label>Mot de passe</label><input type="password" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
        <button class="auth-btn" onclick="signup()">Cr√©er mon compte</button>
      </div>
      <div class="auth-divider">ou</div>
      <button class="auth-google" onclick="signInWithGoogle()">
        <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/><path fill="#FBBC05" d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/></svg>
        Continuer avec Google
      </button>
    </div>
  </div>

  <!-- APP -->
  <div class="screen app-screen" id="appScreen">
    <div class="header">
      <div class="header-left">
        <div class="header-avatar" id="headerAvatar"></div>
        <div class="header-username" id="headerUsername"></div>
      </div>
      <div class="header-right">
        <div class="header-date" id="headerDate"></div>
        <button class="theme-toggle" onclick="toggleTheme()">
          <span id="themeIcon">‚òÄÔ∏è</span><span id="themeLabel">Clair</span>
        </button>
        <button class="btn-logout" onclick="logout()">D√©connexion</button>
      </div>
    </div>
    <div class="sync-bar">
      <div class="sync-dot" id="syncDot"></div>
      <span id="syncText">‚Äî</span>
    </div>
    <div class="scroll">
      <div class="main-grid">

        <!-- FAQ -->
        <div class="faq-section" id="faqSection">
          <div class="faq-header" onclick="toggleFaq()">
            <div class="faq-header-left">
              <span class="faq-header-icon">üí°</span>
              <span class="faq-header-title">Questions fr√©quentes</span>
            </div>
            <span class="faq-chevron">‚ñæ</span>
          </div>
          <div class="faq-body">
            <div class="faq-item">
              <div class="faq-question" onclick="toggleFaqItem(this)">
                Qu'est-ce que le PEA ?
                <span class="faq-question-chevron">‚ñæ</span>
              </div>
              <div class="faq-answer">Le Plan d'√âpargne en Actions (PEA) est une enveloppe fiscale fran√ßaise qui permet d'investir en actions europ√©ennes avec une fiscalit√© avantageuse apr√®s 5 ans de d√©tention. Les plus-values et dividendes sont exon√©r√©s d'imp√¥t sur le revenu (hors pr√©l√®vements sociaux) apr√®s cette p√©riode.</div>
            </div>
            <div class="faq-item">
              <div class="faq-question" onclick="toggleFaqItem(this)">
                Quel est le plafond de versements ?
                <span class="faq-question-chevron">‚ñæ</span>
              </div>
              <div class="faq-answer">Le plafond des versements sur un PEA classique est de 150 000 ‚Ç¨. Ce tracker vous aide √† visualiser votre progression vers ce plafond et √† estimer quand vous l'atteindrez. Attention : seuls les versements comptent dans le plafond, pas la valeur du portefeuille.</div>
            </div>
            <div class="faq-item">
              <div class="faq-question" onclick="toggleFaqItem(this)">
                Comment fonctionne le versement automatique ?
                <span class="faq-question-chevron">‚ñæ</span>
              </div>
              <div class="faq-answer">Configurez un montant et un jour du mois dans les Param√®tres (ic√¥ne ‚öôÔ∏è). Chaque mois, une fois ce jour atteint, le versement est ajout√© automatiquement √† votre historique, marqu√© avec le badge ¬´ auto ¬ª. Il n'est d√©clench√© qu'une seule fois par mois.</div>
            </div>
            <div class="faq-item">
              <div class="faq-question" onclick="toggleFaqItem(this)">
                Puis-je modifier ou supprimer un versement ?
                <span class="faq-question-chevron">‚ñæ</span>
              </div>
              <div class="faq-answer">Oui. Dans l'historique, chaque versement dispose d'un bouton ‚úè pour le modifier (montant, date, note) et d'un bouton ‚úï pour le supprimer. Les versements automatiques peuvent √©galement √™tre modifi√©s ou supprim√©s manuellement.</div>
            </div>
            <div class="faq-item">
              <div class="faq-question" onclick="toggleFaqItem(this)">
                Mes donn√©es sont-elles s√©curis√©es ?
                <span class="faq-question-chevron">‚ñæ</span>
              </div>
              <div class="faq-answer">Vos donn√©es sont stock√©es dans Firebase Firestore (Google Cloud) et accessibles uniquement avec votre compte. Elles sont isol√©es par utilisateur gr√¢ce aux r√®gles de s√©curit√© Firestore. Ce tracker ne stocke que les montants et dates de vos versements, aucune donn√©e bancaire.</div>
            </div>
          </div>
        </div>

        <div class="hero">
          <div class="hero-label">Total vers√©</div>
          <div class="hero-amount"><span>‚Ç¨</span><span id="heroAmount">0</span></div>
          <div class="hero-sub">Reste <b id="heroRemain">150 000</b> ‚Ç¨ pour atteindre le plafond</div>
          <div class="progress-track"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
          <div class="progress-labels"><span>0 ‚Ç¨</span><span class="progress-pct" id="progressPct">0%</span><span>150 000 ‚Ç¨</span></div>
        </div>
        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-label">Versements</div>
            <div class="stat-value" id="statCount">0</div>
            <div class="stat-sub">op√©rations</div>
          </div>
          <div class="stat-card highlight">
            <div class="stat-label">Moy. mensuelle</div>
            <div class="stat-value green" id="statAvg">‚Äî</div>
            <div class="stat-sub">sur <span id="statMonths">0</span> mois</div>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <div class="chart-title">√âvolution du PEA</div>
            <div class="chart-total" id="chartTotal"></div>
          </div>
          <div class="chart-wrap">
            <canvas id="chartCanvas"></canvas>
            <div class="chart-empty hidden" id="chartEmpty">Ajoute des versements pour voir le graphique</div>
          </div>
        </div>
        <div class="est-card">
          <div class="est-icon">üéØ</div>
          <div>
            <div class="est-label">Plafond 150k‚Ç¨ estim√©</div>
            <div class="est-date" id="estDate">Configurer ‚Üí</div>
            <div class="est-detail" id="estDetail">Ajouter un versement mensuel estim√©</div>
          </div>
        </div>
        <div class="section-title">Historique</div>
        <div class="history-list" id="historyList">
          <div class="empty-state">Aucun versement enregistr√©</div>
        </div>
      </div>
    </div>
    <div class="fab">
      <button class="btn-settings" onclick="openSettings()">‚öôÔ∏è</button>
      <button class="btn-add" onclick="openAdd()">+ Ajouter un versement</button>
    </div>
  </div>

  <!-- MODALS -->
  <div class="overlay" id="addOverlay" onclick="if(event.target===this)closeModal('addOverlay')">
    <div class="modal">
      <div class="modal-handle"></div>
      <div class="modal-title">Nouveau versement</div>
      <div class="field"><label>Montant (‚Ç¨)</label><input type="number" id="inputAmount" inputmode="decimal" placeholder="1 000" min="0" /></div>
      <div class="field"><label>Date</label><input type="date" id="inputDate" /></div>
      <div class="field"><label>Note (optionnel)</label><input type="text" id="inputNote" placeholder="√âpargne mensuelle‚Ä¶" maxlength="40" /></div>
      <div class="modal-btns">
        <button class="btn-cancel" onclick="closeModal('addOverlay')">Annuler</button>
        <button class="btn-confirm" onclick="addVersement()">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- EDIT VERSEMENT -->
  <div class="overlay" id="editOverlay" onclick="if(event.target===this)closeModal('editOverlay')">
    <div class="modal">
      <div class="modal-handle"></div>
      <div class="modal-title">Modifier le versement</div>
      <div class="field"><label>Montant (‚Ç¨)</label><input type="number" id="editAmount" inputmode="decimal" placeholder="1 000" min="0" /></div>
      <div class="field"><label>Date</label><input type="date" id="editDate" /></div>
      <div class="field"><label>Note (optionnel)</label><input type="text" id="editNote" placeholder="√âpargne mensuelle‚Ä¶" maxlength="40" /></div>
      <div class="modal-btns">
        <button class="btn-cancel" onclick="closeModal('editOverlay')">Annuler</button>
        <button class="btn-confirm" onclick="saveEditVersement()">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div class="overlay" id="settingsOverlay" onclick="if(event.target===this)closeModal('settingsOverlay')">
    <div class="modal">
      <div class="modal-handle"></div>
      <div class="modal-title">Param√®tres</div>
      <div class="field"><label>Solde de d√©part (‚Ç¨)</label><input type="number" id="inputSoldeDepart" inputmode="decimal" placeholder="50 000" min="0" /></div>
      <div class="field"><label>Versement mensuel estim√© (‚Ç¨)</label><input type="number" id="inputMonthly" inputmode="decimal" placeholder="500" min="0" /></div>
      <div class="field"><label>Versement automatique mensuel (‚Ç¨)</label><input type="number" id="inputMontantAuto" inputmode="decimal" placeholder="500" min="0" /></div>
      <div class="field"><label>Jour du versement automatique (1‚Äì28)</label><input type="number" id="inputJourVersement" inputmode="numeric" placeholder="1" min="1" max="28" /></div>
      <div class="settings-info" id="settingsInfo"></div>
      <div class="danger-zone">
        <div class="danger-zone-title">‚ö† Zone danger</div>
        <button class="btn-danger" onclick="resetData()">Effacer mes donn√©es</button>
      </div>
      <div class="modal-btns">
        <button class="btn-cancel" onclick="closeModal('settingsOverlay')">Annuler</button>
        <button class="btn-confirm" onclick="saveSettings()">Sauvegarder</button>
      </div>
    </div>
  </div>

  <!-- ONBOARDING (nouveau compte) -->
  <div class="overlay" id="onboardingOverlay">
    <div class="modal">
      <div class="modal-handle"></div>
      <div class="modal-title">Bienvenue ! Configurez votre PEA</div>
      <p class="settings-info">Param√©trez votre tracker en quelques secondes. Vous pourrez modifier ces valeurs plus tard dans les r√©glages.</p>
      <div class="field"><label>Solde de d√©part (‚Ç¨)</label><input type="number" id="onboardSolde" inputmode="decimal" placeholder="ex : 50 000" min="0" /></div>
      <div class="field"><label>Montant du versement automatique mensuel (‚Ç¨)</label><input type="number" id="onboardMontant" inputmode="decimal" placeholder="ex : 500" min="0" /></div>
      <div class="field"><label>Jour du mois pour le versement automatique (1‚Äì28)</label><input type="number" id="onboardJour" inputmode="numeric" placeholder="ex : 5" min="1" max="28" /></div>
      <div class="modal-btns">
        <button class="btn-cancel" onclick="closeModal('onboardingOverlay')">Passer</button>
        <button class="btn-confirm" onclick="saveOnboarding()">Commencer</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, updateProfile } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, deleteDoc, updateDoc, onSnapshot, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const app = initializeApp({
      apiKey:"AIzaSyDvgEu3IaEev29mQ0sU4jeYDl9HzGnTgcE",
      authDomain:"pea-tracker-public.firebaseapp.com",
      projectId:"pea-tracker-public",
      storageBucket:"pea-tracker-public.firebasestorage.app",
      messagingSenderId:"494794661938",
      appId:"1:494794661938:web:678108f03877456afb1c2b"
    });

    const auth = getAuth(app);
    const db = getFirestore(app);

    let user, unsub, settings={soldeDepart:0,monthly:0,montantAuto:0,jourVersement:0,lastAutoMonth:''}, firstLoad=true, versements=null, pendingOnboarding=false, editingId=null;

    onAuthStateChanged(auth, u => u ? (user=u,showApp()) : (user=null,showAuth()));

    function showAuth() {
      document.getElementById('loaderScreen').classList.remove('active');
      document.getElementById('authScreen').classList.add('active');
      document.getElementById('appScreen').classList.remove('active');
    }

    async function showApp() {
      document.getElementById('loaderScreen').classList.remove('active');
      document.getElementById('authScreen').classList.remove('active');
      document.getElementById('appScreen').classList.add('active');

      const name = user.displayName || user.email.split('@')[0];
      document.getElementById('headerAvatar').textContent = name[0].toUpperCase();
      document.getElementById('headerUsername').textContent = name;
      setSyncStatus('syncing','Chargement‚Ä¶');

      try {
        const s = await getDoc(doc(db,'users',user.uid));
        if(s.exists()) {
          const d=s.data();
          settings = {
            soldeDepart:d.soldeDepart||0,
            monthly:d.monthly||0,
            montantAuto:d.montantAuto||0,
            jourVersement:d.jourVersement||0,
            lastAutoMonth:d.lastAutoMonth||''
          };
        } else {
          settings={soldeDepart:0,monthly:0,montantAuto:0,jourVersement:0,lastAutoMonth:''};
        }
      } catch(e) { settings={soldeDepart:0,monthly:0,montantAuto:0,jourVersement:0,lastAutoMonth:''}; }

      if(unsub) unsub();
      const q = query(collection(db,'users',user.uid,'versements'),orderBy('date','desc'));
      firstLoad=true;
      unsub = onSnapshot(q,snap=>{
        versements = snap.docs.map(d=>({id:d.id,...d.data()}));
        const isNew = !firstLoad && snap.docChanges().some(c=>c.type==='added');
        if(isNew) launchConfetti();
        if(firstLoad) {
          firstLoad=false;
          checkAutoVersement();
        } else { firstLoad=false; }
        setSyncStatus('synced','Synchronis√©');
        render(versements);
      },()=>setSyncStatus('syncing','Erreur'));

      if(pendingOnboarding) {
        pendingOnboarding=false;
        setTimeout(()=>openOnboarding(),600);
      }
    }

    window.switchTab = t => {
      document.getElementById('tabSignin').classList.toggle('active',t==='signin');
      document.getElementById('tabSignup').classList.toggle('active',t==='signup');
      document.getElementById('signinForm').style.display = t==='signin'?'block':'none';
      document.getElementById('signupForm').style.display = t==='signup'?'block':'none';
      hideError();
    };

    window.signup = async ()=> {
      const name=document.getElementById('signupName').value.trim();
      const email=document.getElementById('signupEmail').value.trim();
      const pass=document.getElementById('signupPassword').value;
      if(!name||!email||!pass) return showError('Tous les champs sont requis');
      if(pass.length<6) return showError('Mot de passe trop court (min 6 caract√®res)');
      try {
        pendingOnboarding=true;
        const c = await createUserWithEmailAndPassword(auth,email,pass);
        await updateProfile(c.user,{displayName:name});
        await setDoc(doc(db,'users',c.user.uid),{name,email,soldeDepart:0,monthly:0,montantAuto:0,jourVersement:0,lastAutoMonth:''});
      } catch(e) {
        pendingOnboarding=false;
        showError(e.code==='auth/email-already-in-use'?'Cet email est d√©j√† utilis√©':'Erreur: '+e.message);
      }
    };

    window.signin = async ()=> {
      const email=document.getElementById('signinEmail').value.trim();
      const pass=document.getElementById('signinPassword').value;
      if(!email||!pass) return showError('Email et mot de passe requis');
      try {
        await signInWithEmailAndPassword(auth,email,pass);
      } catch(e) {
        showError(e.code==='auth/invalid-credential'?'Email ou mot de passe incorrect':'Erreur: '+e.message);
      }
    };

    window.signInWithGoogle = async ()=> {
      try {
        const result = await signInWithPopup(auth, new GoogleAuthProvider());
        const s = await getDoc(doc(db,'users',result.user.uid));
        if (!s.exists()) {
          pendingOnboarding = true;
          await setDoc(doc(db,'users',result.user.uid),{
            name:result.user.displayName, email:result.user.email,
            soldeDepart:0, monthly:0, montantAuto:0, jourVersement:0, lastAutoMonth:''
          });
        }
      } catch(e) { showError('Erreur de connexion Google'); }
    };

    window.logout = () => signOut(auth);

    function showError(msg) { document.getElementById('authError').textContent=msg; document.getElementById('authError').classList.add('show'); }
    function hideError() { document.getElementById('authError').classList.remove('show'); }

    const THEME_KEY='pea_theme';
    function applyTheme(t) {
      document.documentElement.classList.toggle('light',t==='light');
      document.getElementById('themeIcon').textContent = t==='light'?'üåô':'‚òÄÔ∏è';
      document.getElementById('themeLabel').textContent = t==='light'?'Sombre':'Clair';
      document.querySelector('meta[name="theme-color"]').setAttribute('content',t==='light'?'#f5f2ec':'#0a0a0f');
    }
    window.toggleTheme = () => {
      const t = document.documentElement.classList.contains('light')?'dark':'light';
      localStorage.setItem(THEME_KEY,t);
      applyTheme(t);
      if(versements) drawChart(versements);
    };

    // CONFETTIS
    const confCanvas = document.getElementById('confetti-canvas');
    const confCtx = confCanvas.getContext('2d');
    let confettiParticles=[],confettiRAF=null;

    function launchConfetti() {
      confCanvas.width=window.innerWidth; confCanvas.height=window.innerHeight;
      confettiParticles=[];
      const colors=['#c9a84c','#e8c97a','#3ecf8e','#7de8b8','#ff6b9d','#a78bfa','#38bdf8'];
      for(let i=0;i<120;i++) {
        confettiParticles.push({
          x:Math.random()*confCanvas.width,y:Math.random()*confCanvas.height-confCanvas.height,
          w:Math.random()*10+4,h:Math.random()*6+3,
          color:colors[Math.floor(Math.random()*colors.length)],
          vx:(Math.random()-0.5)*6,vy:Math.random()*8+4,
          angle:Math.random()*Math.PI*2,spin:(Math.random()-0.5)*0.4,alpha:1
        });
      }
      if(confettiRAF) cancelAnimationFrame(confettiRAF);
      animateConfetti();
    }

    function animateConfetti() {
      confCtx.clearRect(0,0,confCanvas.width,confCanvas.height);
      confettiParticles.forEach(p=>{
        p.x+=p.vx;p.y+=p.vy;p.angle+=p.spin;
        if(p.y>confCanvas.height*0.6)p.alpha-=0.04;
        confCtx.save();
        confCtx.globalAlpha=Math.max(0,p.alpha);
        confCtx.translate(p.x,p.y);confCtx.rotate(p.angle);
        confCtx.fillStyle=p.color;
        confCtx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
        confCtx.restore();
      });
      confettiParticles=confettiParticles.filter(p=>p.alpha>0);
      if(confettiParticles.length>0) confettiRAF=requestAnimationFrame(animateConfetti);
      else confCtx.clearRect(0,0,confCanvas.width,confCanvas.height);
    }

    // GRAPHIQUE
    function drawChart(v) {
      const canvas=document.getElementById('chartCanvas');
      const empty=document.getElementById('chartEmpty');
      const isLight=document.documentElement.classList.contains('light');

      if(v.length===0) {
        canvas.style.display='none';
        empty.classList.remove('hidden');
        document.getElementById('chartTotal').textContent='';
        return;
      }

      canvas.style.display='block';
      empty.classList.add('hidden');

      const sorted=[...v].sort((a,b)=>a.date.localeCompare(b.date));
      const base=settings.soldeDepart;
      let cumul=base;
      const points=[{label:'D√©part',value:base}];
      sorted.forEach(v=>{
        cumul+=v.amount;
        const d=new Date(v.date+'T12:00:00');
        points.push({label:d.toLocaleDateString('fr-FR',{month:'short',year:'2-digit'}),value:cumul});
      });

      const wrap=canvas.parentElement;
      canvas.width=wrap.clientWidth*window.devicePixelRatio;
      canvas.height=wrap.clientHeight*window.devicePixelRatio;
      canvas.style.width=wrap.clientWidth+'px';
      canvas.style.height=wrap.clientHeight+'px';

      const ctx=canvas.getContext('2d');
      ctx.scale(window.devicePixelRatio,window.devicePixelRatio);
      const W=wrap.clientWidth,H=wrap.clientHeight;
      const PAD={top:10,right:10,bottom:24,left:0};
      const gW=W-PAD.left-PAD.right,gH=H-PAD.top-PAD.bottom;

      const MAX_LINE=150000;
      const maxV=Math.max(MAX_LINE,cumul);
      const toX=i=>PAD.left+(i/(points.length-1))*gW;
      const toY=v=>PAD.top+gH-(v/maxV)*gH;

      ctx.clearRect(0,0,W,H);

      const y150=toY(MAX_LINE);
      ctx.save();ctx.setLineDash([4,4]);
      ctx.strokeStyle=isLight?'rgba(160,120,40,0.25)':'rgba(201,168,76,0.25)';
      ctx.lineWidth=1;ctx.beginPath();
      ctx.moveTo(PAD.left,y150);ctx.lineTo(W-PAD.right,y150);ctx.stroke();ctx.restore();

      const grad=ctx.createLinearGradient(0,PAD.top,0,H);
      grad.addColorStop(0,isLight?'rgba(160,120,40,0.18)':'rgba(201,168,76,0.2)');
      grad.addColorStop(1,'rgba(0,0,0,0)');

      ctx.beginPath();
      points.forEach((p,i)=>{const x=toX(i),y=toY(p.value);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
      ctx.lineTo(toX(points.length-1),H-PAD.bottom);ctx.lineTo(PAD.left,H-PAD.bottom);ctx.closePath();
      ctx.fillStyle=grad;ctx.fill();

      ctx.beginPath();ctx.lineWidth=2;
      ctx.strokeStyle=isLight?'#a07828':'#e8c97a';
      ctx.lineJoin='round';ctx.lineCap='round';
      points.forEach((p,i)=>{const x=toX(i),y=toY(p.value);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
      ctx.stroke();

      points.forEach((p,i)=>{
        const x=toX(i),y=toY(p.value);
        ctx.beginPath();ctx.arc(x,y,3,0,Math.PI*2);
        ctx.fillStyle=isLight?'#a07828':'#e8c97a';ctx.fill();
        if(i>0||points.length<=4) {
          ctx.fillStyle=isLight?'rgba(26,22,18,0.35)':'rgba(240,237,230,0.3)';
          ctx.font=`${9*window.devicePixelRatio/window.devicePixelRatio}px DM Mono,monospace`;
          ctx.textAlign='center';ctx.fillText(p.label,x,H-PAD.bottom+14);
        }
      });

      document.getElementById('chartTotal').textContent=fmtEur(cumul)+' ‚Ç¨';
    }

    function setSyncStatus(state,text) {
      document.getElementById('syncDot').className='sync-dot '+state;
      document.getElementById('syncText').textContent=text;
    }

    const fmtEur=v=>new Intl.NumberFormat('fr-FR',{minimumFractionDigits:0,maximumFractionDigits:0}).format(v);
    const fmtDate=d=>new Date(d+'T12:00:00').toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric'});
    const today=()=>new Date().toISOString().slice(0,10);

    function render(v) {
      const MAX=150000;
      const total=settings.soldeDepart+v.reduce((s,v)=>s+v.amount,0);
      const remain=Math.max(0,MAX-total);
      const pct=Math.min(100,(total/MAX)*100);

      document.getElementById('headerDate').textContent=new Date().toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric'});
      document.getElementById('heroAmount').textContent=fmtEur(total);
      document.getElementById('heroRemain').textContent=fmtEur(remain);
      document.getElementById('progressFill').style.width=pct+'%';
      document.getElementById('progressPct').textContent=pct.toFixed(1)+'%';

      const n=v.length;
      document.getElementById('statCount').textContent=n;

      let avgText='‚Äî',months=0;
      if(n>0) {
        const sum=v.reduce((s,v)=>s+v.amount,0);
        const dates=v.map(v=>new Date(v.date));
        const minD=new Date(Math.min(...dates)),maxD=new Date(Math.max(...dates));
        months=Math.max(1,Math.round((maxD-minD)/(1000*60*60*24*30.4))+1);
        avgText=fmtEur(sum/months)+' ‚Ç¨';
        document.getElementById('statMonths').textContent=months;
      }
      document.getElementById('statAvg').textContent=avgText;

      const monthly=settings.monthly;
      if(remain<=0) {
        document.getElementById('estDate').textContent='üéâ Plafond atteint !';
        document.getElementById('estDetail').textContent='F√©licitations, ton PEA est plein.';
      } else if(monthly>0) {
        const monthsLeft=Math.ceil(remain/monthly);
        const target=new Date();
        target.setMonth(target.getMonth()+monthsLeft);
        document.getElementById('estDate').textContent=target.toLocaleDateString('fr-FR',{month:'long',year:'numeric'});
        document.getElementById('estDetail').textContent=`Dans ${monthsLeft} mois ¬∑ ${fmtEur(monthly)} ‚Ç¨/mois estim√©`;
      } else {
        document.getElementById('estDate').textContent='Non configur√©';
        document.getElementById('estDetail').textContent='Configurer un versement mensuel estim√© ‚Üó';
      }

      requestAnimationFrame(()=>drawChart(v));

      const list=document.getElementById('historyList');
      if(n===0) {
        list.innerHTML='<div class="empty-state">Aucun versement enregistr√©</div>';
      } else {
        list.innerHTML=v.map(v=>`
          <div class="history-item">
            <div class="history-left">
              <div class="history-date">${fmtDate(v.date)}${v.auto?'<span class="auto-badge">auto</span>':''}</div>
              ${v.note&&!v.auto?`<div class="history-note">${v.note}</div>`:''}
            </div>
            <div style="display:flex;align-items:center">
              <div class="history-amount">+${fmtEur(v.amount)} ‚Ç¨</div>
              <button class="history-edit" onclick="openEditVersement('${v.id}')" title="Modifier">‚úè</button>
              <button class="history-delete" onclick="deleteVersement('${v.id}')" title="Supprimer">‚úï</button>
            </div>
          </div>
        `).join('');
      }
    }

    window.openAdd = ()=> {
      document.getElementById('inputDate').value=today();
      document.getElementById('inputAmount').value='';
      document.getElementById('inputNote').value='';
      document.getElementById('addOverlay').classList.add('open');
      setTimeout(()=>document.getElementById('inputAmount').focus(),400);
    };

    window.addVersement = async ()=> {
      const amount=parseFloat(document.getElementById('inputAmount').value);
      const date=document.getElementById('inputDate').value;
      const note=document.getElementById('inputNote').value.trim();
      if(!amount||amount<=0||!date) return;
      setSyncStatus('syncing','Enregistrement‚Ä¶');
      try {
        await addDoc(collection(db,'users',user.uid,'versements'),{amount,date,note});
        closeModal('addOverlay');
      } catch(e) { setSyncStatus('syncing','Erreur'); }
    };

    window.deleteVersement = async id=> {
      if(!confirm('Supprimer ce versement ?')) return;
      setSyncStatus('syncing','Suppression‚Ä¶');
      try {
        await deleteDoc(doc(db,'users',user.uid,'versements',id));
      } catch(e) { setSyncStatus('syncing','Erreur'); }
    };

    window.openEditVersement = id=> {
      const v = versements.find(x=>x.id===id);
      if(!v) return;
      editingId=id;
      document.getElementById('editAmount').value=v.amount;
      document.getElementById('editDate').value=v.date;
      document.getElementById('editNote').value=v.note||'';
      document.getElementById('editOverlay').classList.add('open');
      setTimeout(()=>document.getElementById('editAmount').focus(),400);
    };

    window.saveEditVersement = async ()=> {
      const amount=parseFloat(document.getElementById('editAmount').value);
      const date=document.getElementById('editDate').value;
      const note=document.getElementById('editNote').value.trim();
      if(!amount||amount<=0||!date||!editingId) return;
      setSyncStatus('syncing','Enregistrement‚Ä¶');
      try {
        await updateDoc(doc(db,'users',user.uid,'versements',editingId),{amount,date,note,auto:false});
        editingId=null;
        closeModal('editOverlay');
      } catch(e) { setSyncStatus('syncing','Erreur'); }
    };

    async function checkAutoVersement() {
      if(!settings.montantAuto||settings.montantAuto<=0) return;
      if(!settings.jourVersement||settings.jourVersement<=0) return;
      const now=new Date();
      const currentMonth=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      if(settings.lastAutoMonth===currentMonth) return;
      if(now.getDate()<settings.jourVersement) return;
      const autoDate=`${currentMonth}-${String(settings.jourVersement).padStart(2,'0')}`;
      setSyncStatus('syncing','Versement auto‚Ä¶');
      try {
        await addDoc(collection(db,'users',user.uid,'versements'),{
          amount:settings.montantAuto,
          date:autoDate,
          note:'Versement automatique',
          auto:true
        });
        settings.lastAutoMonth=currentMonth;
        await setDoc(doc(db,'users',user.uid),{lastAutoMonth:currentMonth},{merge:true});
      } catch(e) { setSyncStatus('syncing','Erreur'); }
    }

    window.openOnboarding = ()=> {
      document.getElementById('onboardSolde').value='';
      document.getElementById('onboardMontant').value='';
      document.getElementById('onboardJour').value='';
      document.getElementById('onboardingOverlay').classList.add('open');
    };

    window.saveOnboarding = async ()=> {
      const solde=parseFloat(document.getElementById('onboardSolde').value)||0;
      const montant=parseFloat(document.getElementById('onboardMontant').value)||0;
      const jour=parseInt(document.getElementById('onboardJour').value)||0;
      const clampedJour=Math.min(28,Math.max(0,jour));
      settings.soldeDepart=solde;
      settings.montantAuto=montant;
      settings.jourVersement=clampedJour;
      settings.monthly=montant;
      setSyncStatus('syncing','Sauvegarde‚Ä¶');
      try {
        await setDoc(doc(db,'users',user.uid),{
          soldeDepart:solde,
          montantAuto:montant,
          jourVersement:clampedJour,
          monthly:montant
        },{merge:true});
        closeModal('onboardingOverlay');
        if(versements) render(versements);
        setSyncStatus('synced','Synchronis√©');
      } catch(e) { setSyncStatus('syncing','Erreur'); }
    };

    window.openSettings = ()=> {
      document.getElementById('inputSoldeDepart').value=settings.soldeDepart||'';
      document.getElementById('inputMonthly').value=settings.monthly||'';
      document.getElementById('inputMontantAuto').value=settings.montantAuto||'';
      document.getElementById('inputJourVersement').value=settings.jourVersement||'';
      let info='';
      if(settings.soldeDepart) info+=`Solde de d√©part : ${fmtEur(settings.soldeDepart)} ‚Ç¨\n`;
      if(settings.montantAuto&&settings.jourVersement) info+=`Auto : ${fmtEur(settings.montantAuto)} ‚Ç¨ le ${settings.jourVersement} de chaque mois`;
      document.getElementById('settingsInfo').textContent=info;
      document.getElementById('settingsOverlay').classList.add('open');
    };

    window.saveSettings = async ()=> {
      settings.soldeDepart=parseFloat(document.getElementById('inputSoldeDepart').value)||0;
      settings.monthly=parseFloat(document.getElementById('inputMonthly').value)||0;
      settings.montantAuto=parseFloat(document.getElementById('inputMontantAuto').value)||0;
      settings.jourVersement=Math.min(28,Math.max(0,parseInt(document.getElementById('inputJourVersement').value)||0));
      setSyncStatus('syncing','Sauvegarde‚Ä¶');
      try {
        await setDoc(doc(db,'users',user.uid),{
          soldeDepart:settings.soldeDepart,
          monthly:settings.monthly,
          montantAuto:settings.montantAuto,
          jourVersement:settings.jourVersement
        },{merge:true});
        closeModal('settingsOverlay');
        if(versements) render(versements);
        setSyncStatus('synced','Synchronis√©');
      } catch(e) { setSyncStatus('syncing','Erreur'); }
    };

    window.resetData = async ()=> {
      if(!confirm('Effacer TOUTES vos donn√©es ? Irr√©versible.')) return;
      setSyncStatus('syncing','Suppression‚Ä¶');
      try {
        const snap=await getDocs(collection(db,'users',user.uid,'versements'));
        await Promise.all(snap.docs.map(d=>deleteDoc(d.ref)));
        settings={soldeDepart:0,monthly:0,montantAuto:0,jourVersement:0,lastAutoMonth:''};
        await setDoc(doc(db,'users',user.uid),settings,{merge:true});
        closeModal('settingsOverlay');
        setSyncStatus('synced','Synchronis√©');
      } catch(e) { setSyncStatus('syncing','Erreur'); }
    };

    window.closeModal = id => document.getElementById(id).classList.remove('open');

    document.addEventListener('keydown',e=>{
      if(e.key==='Escape') { closeModal('addOverlay'); closeModal('editOverlay'); closeModal('settingsOverlay'); closeModal('onboardingOverlay'); }
      if(e.key==='Enter') {
        if(document.getElementById('addOverlay').classList.contains('open')) addVersement();
        if(document.getElementById('editOverlay').classList.contains('open')) saveEditVersement();
        if(document.getElementById('settingsOverlay').classList.contains('open')) saveSettings();
        if(document.getElementById('onboardingOverlay').classList.contains('open')) saveOnboarding();
      }
    });

    window.addEventListener('resize',()=>{ if(versements) drawChart(versements); });

    window.toggleFaq = () => {
      const el = document.getElementById('faqSection');
      el.classList.toggle('open');
      localStorage.setItem('pea_faq_open', el.classList.contains('open') ? '1' : '0');
    };

    window.toggleFaqItem = (el) => {
      const item = el.closest('.faq-item');
      const wasOpen = item.classList.contains('open');
      document.querySelectorAll('.faq-item.open').forEach(i => i.classList.remove('open'));
      if (!wasOpen) item.classList.add('open');
    };

    // Restaurer l'√©tat ouvert/ferm√© de la FAQ
    if (localStorage.getItem('pea_faq_open') === '1') {
      document.getElementById('faqSection').classList.add('open');
    }

    applyTheme(localStorage.getItem(THEME_KEY)||'dark');
  </script>
</body>
</html>
